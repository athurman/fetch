#!/usr/bin/env ruby

require_relative 'lib/environment'
require_relative 'lib/parse_arguments'
require_relative 'lib/interactions'
require_relative 'models/role'
require_relative 'models/breed'

class FetchDog
  include Interactions
  attr_reader :options

  def initialize
    @options = ParseArguments.parse
    Environment.environment = @options[:environment] || "production"
  end

  def main
    if options[:command].nil?
      find_dog_breeds_and_return_shelter_dogs()
    elsif options[:command] == "add"
      add_shelter_dog_to_db()
    elsif options[:command] == "list"
      list_shelterdogs()
    elsif options[:command] == "update"
      searched_dog = ShelterDog.search_by_name(options[:name])
      update_shelter_dog_info_for(searched_dog)
    elsif options[:command] == "delete"
      dog_id = ask("Please type the id of the dog named #{options[:name]} that you would like to delete")
      ShelterDog.delete(dog_id)
      tell("Dog #{dog_id}. #{options[:name]} has beend deleted from the shelterdogs table")
    else
      tell("Command not implemented")
    end
  end

  def add_shelter_dog_to_db()
    error_messages = ParseArguments.validate(options)
    if error_messages.empty?
      shelterdog = ShelterDog.new(options)
      shelterdog.save
      tell("A shelter dog named #{options[:name]}, breed: #{options[:breed]}, shelter: #{options[:shelter]}, age: #{options[:age]} weight: #{options[:weight]} lbs. with status of #{options[:status]}.")
    else
      tell(error_messages)
    end
  end

  def list_shelterdogs()
    puts "All Shelter Dogs:"
    puts ShelterDog.all
  end

  def check_results results
    if results == [] || results == "No results found"
      puts "Sorry, we were unable to fulfill your request.  Please try again"
      exit
    end
  end

  def print_dogs(dog_array, breed_name= "dog")
    if dog_array[0].is_a?(Breed)
      puts "Here are the top 5 dog breeds that fit your lifestyle:"
    elsif dog_array[0].is_a?(ShelterDog)
      puts "Here are #{breed_name}s in the surrounding area:"
    end
    dog_array.each do |dog|
      puts dog
      puts
    end
  end

  def find_dog_breeds_and_return_shelter_dogs
    roles = Role.all
      check_results(roles)
      role = give_options("Please select the number of the role you would like for your dog to be.", roles)
      check_results(roles)
      exercises = Breed.return_exercise(role.id)
      check_results(exercises)
      exercises.delete_at(3) if exercises.length == 4
      exercise = give_options("How often do you exercise?", exercises)
      grooming = give_options("Are you willing to groom your dog frequently (at least once a week)?", ["yes", "no"])
      family_friendly = give_options("Does your dog have to be good around children?", ["yes", "no"])
      breeds = Breed.find_top_five(role.id, exercise, grooming, family_friendly)
      check_results(breeds)
      print_dogs(breeds)
      search = give_options("Would you like to search for one of these breeds in local shelters?", ["yes", "no"])
      if search == "yes"
        shelter_breed = give_options("Please type in the number of the breed you would like to search:", breeds)
      else
        tell("Thanks!")
        exit
      end
      shelterdogs = ShelterDog.find_by_breedname(shelter_breed.name)
      check_results(shelterdogs)
      print_dogs(shelterdogs, shelter_breed.name)
  end

  def update_shelter_dog_info_for searched_dog
    unless searched_dog == "The dog you were searching for is not found"
      id = ask("Please select the id of the dog you would like to update.")
      shelterdog = ShelterDog.search_by_id(id)
      if shelterdog.nil?
        tell("No dogs were found with that id, please try again.")
      else
        tell(shelterdog)
        selection = ask("Please select the piece of information you would like to update (age, status, etc.).")
        updated_info = ask("What would you like to change the dog's #{selection} to?")
        shelterdog = shelterdog.update(selection, updated_info, id)
        tell("Dog #{shelterdog.id} is now named #{shelterdog.name}, breed is #{shelterdog.breed}, shelter is #{shelterdog.shelter}, age is #{shelterdog.age}, weight is #{shelterdog.weight}, and status is #{shelterdog.status}")
      end
    else
      tell(searched_dog)
    end
  end
end

fetchdog = FetchDog.new()
fetchdog.main()
